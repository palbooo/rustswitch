<!DOCTYPE html>
<html>
  <head>
    <title>Raven Guard (RVG) - Edit</title>
    <link rel="icon" type="image/x-icon" href="rvg.ico" />
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background-color: #282c34;
        color: #ffffff;
        position: relative;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("rvg.webp");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        filter: blur(8px);
        opacity: 0.15;
        z-index: -1;
      }

      .grid-container {
        display: grid;
        grid-template-columns: repeat(15, 42px);
        grid-template-rows: repeat(5, 42px);
        gap: 1px;
        margin: 2px 0;
        padding: 3px;
        border-radius: 4px;
        width: max-content;
      }

      .grid-cell {
        background: none;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .switch-container {
        position: relative;
        width: 100%;
        height: 100%;
      }

      .switch-button {
        width: 35px;
        height: 35px;
        border: none;
        background-color: #4caf50;
        color: transparent;
        cursor: pointer;
        border-radius: 50%;
        padding: 0;
      }

      .switch-button:hover {
        background-color: #45a049;
      }

      .switch-button.off {
        background-color: #f44336;
      }

      .status {
        padding: 10px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        margin-left: 5px;
      }

      @keyframes pulse {
        0% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
        }
        70% {
          transform: scale(1);
          box-shadow: 0 0 0 6px rgba(76, 175, 80, 0);
        }
        100% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
        }
      }

      @keyframes pulse-error {
        0% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7);
        }
        70% {
          transform: scale(1);
          box-shadow: 0 0 0 6px rgba(244, 67, 54, 0);
        }
        100% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(244, 67, 54, 0);
        }
      }

      .status-circle {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #4caf50;
        animation: pulse 2s infinite;
      }

      .status.error .status-circle {
        background-color: #f44336;
        animation: pulse-error 2s infinite;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px;
        background-color: rgba(33, 150, 243, 0.9);
        color: white;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1000;
      }

      .panel-section {
        margin-bottom: 30px;
        padding: 8px;
        background-color: rgba(33, 37, 43, 0.95);
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        width: fit-content;
        margin: 0 auto;
        display: flex;
        justify-content: center;
      }

      h2 {
        margin-top: 0;
        color: #ffffff;
      }

      h1 {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div
      style="
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        width: 100%;
      "
    >
      <h1>Raven Guard (RVG)</h1>
      <div id="status" class="status">
        <div class="status-circle"></div>
      </div>
    </div>
    <div id="notification" class="notification"></div>

    <div class="panel-section">
      <div class="grid-container" id="switchGrid"></div>
    </div>

    <script>
      let ws;
      let reconnectAttempt = 0;
      const MAX_RECONNECT_DELAY = 5000;
      const switches = new Map();
      const grid = document.getElementById("switchGrid");
      const notification = document.getElementById("notification");

      function showNotification(message) {
        notification.textContent = message;
        notification.style.display = "block";
        setTimeout(() => {
          notification.style.display = "none";
        }, 5000);
      }

      function initializeGrid() {
        for (let row = 0; row < 5; row++) {
          for (let col = 0; col < 15; col++) {
            const cell = document.createElement("div");
            cell.className = "grid-cell";
            cell.dataset.position = `${row}-${col}`;
            grid.appendChild(cell);
          }
        }
      }

      function addSwitch(switchData, position) {
        const cell = document.querySelector(`[data-position="${position}"]`);
        if (!cell) return;

        const container = document.createElement("div");
        container.className = "switch-container";

        const button = document.createElement("button");
        button.className = "switch-button";
        button.dataset.switchId = switchData.switchId;
        button.classList.toggle("off", !switchData.lastState);
        button.addEventListener("click", () =>
          toggleSwitch(switchData.switchId)
        );

        container.appendChild(button);
        cell.innerHTML = "";
        cell.appendChild(container);
        switches.set(switchData.switchId, { ...switchData, position });
      }

      function loadExistingSwitches(switchesData) {
        switchesData.forEach((switchData) => {
          const position = `${switchData.position.row}-${switchData.position.col}`;
          addSwitch(switchData, position);
        });
      }

      function toggleSwitch(switchId) {
        const switchData = switches.get(switchId);
        if (!switchData) return;

        ws.send(
          JSON.stringify({
            type: "toggleSwitch",
            switchId: switchId,
            state: !switchData.lastState,
          })
        );
      }

      function connect() {
        ws = new WebSocket(
          `${window.location.protocol === "https:" ? "wss:" : "ws:"}//${
            window.location.host
          }`
        );

        // Ping timeout handling
        ws.pingTimeout = null;

        function heartbeat() {
          clearTimeout(ws.pingTimeout);

          // Warte 5s länger als das Server Ping-Intervall (15s + 5s = 20s)
          ws.pingTimeout = setTimeout(() => {
            console.log("WebSocket Verbindung timeout - schließe Verbindung");
            ws.close();
          }, 20000);
        }

        ws.onopen = () => {
          console.log("WebSocket verbunden");
          document.getElementById("status").className = "status";
          ws.send(JSON.stringify({ type: "loadSwitches" }));
          reconnectAttempt = 0;
          heartbeat();
        };

        ws.onclose = () => {
          console.log("WebSocket getrennt");
          document.getElementById("status").className = "status error";
          clearTimeout(ws.pingTimeout);

          // Exponentielles Backoff für Reconnect
          const delay = Math.min(
            1000 * Math.pow(2, reconnectAttempt),
            MAX_RECONNECT_DELAY
          );
          console.log(`Versuche Reconnect in ${delay}ms...`);
          setTimeout(() => {
            reconnectAttempt++;
            connect();
          }, delay);
        };

        ws.onerror = (error) => {
          console.error("WebSocket Fehler:", error);
          document.getElementById("status").className = "status error";
        };

        ws.onmessage = (event) => {
          heartbeat();

          const data = JSON.parse(event.data);
          switch (data.type) {
            case "switchesLoaded":
              loadExistingSwitches(data.switches);
              break;

            case "switchStateChanged":
              const button = document.querySelector(
                `[data-switch-id="${data.switchId}"]`
              );
              if (button) {
                button.classList.toggle("off", !data.state);
                const switchData = switches.get(data.switchId);
                if (switchData) {
                  switchData.lastState = data.state;
                }
              }
              break;

            case "error":
              showNotification(data.message);
              break;
          }
        };
      }

      // Initialize the grid and start WebSocket connection
      initializeGrid();
      connect();
    </script>
  </body>
</html>
